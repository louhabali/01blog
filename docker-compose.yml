# Docker Compose file to define and run multi-container Docker applications 
services:
# Define Postgres database service
  db:
  # Use official Postgres image version 15
    image: postgres:15
    restart: always
    environment:
    # Set Postgres environment variables to create DB and user
      POSTGRES_USER: alouhab
      POSTGRES_PASSWORD: alilo
      POSTGRES_DB: 01-blogdb
    ports:
    # set up port mapping for Postgres
      - "5432:5432"
    volumes: 
      - db-data:/var/lib/postgresql/data
    networks:
    # connect to blog-network ,which is defined below
      - blog-network
# Define backend service
  backend:
  #  this line searches for Dockerfile in the specified directory to build the image
    build: ./01-back
    ports:
    # map host port 8087 to container port 8088
      - "8087:8088"
    environment:
    # Set environment variables for Spring Boot application so that it can connect to Postgres DB
      SERVER_PORT: 8088
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/01-blogdb
      SPRING_DATASOURCE_USERNAME: alouhab
      SPRING_DATASOURCE_PASSWORD: alilo
    networks:
    # connect to blog-network which is the shared network for all services
      - blog-network
    depends_on:
    # ensure that the db service is started before the backend service
      - db

  frontend:
  # this line searches for Dockerfile in the specified directory to build the image
    build: ./01-front
    ports:
    # map host port 4200 to container port 80
      - "4200:80"
      
    networks:
    # connect to blog-network
      - blog-network
    depends_on:
    # ensure that the backend service is started before the frontend service
      - backend
# Define custom network for inter-service communication
networks:
  # this network allows containers to communicate with each other
  blog-network:
  # use the default bridge driver for container networking , if we dont set it , bridge is used by default
  # its role is to allow containers to communicate within the same host
    driver: bridge
volumes:
  db-data:
